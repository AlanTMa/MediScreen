<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediScreen Calendar</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'SF Pro Display', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #0f0f0f;
            color: #e5e5e5;
            line-height: 1.4;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #1a1a1a;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        .header {
            background: #1a1a1a;
            border-bottom: 1px solid #333333;
            padding: 20px 24px;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 400;
            color: #ffffff;
            margin-bottom: 4px;
            letter-spacing: 0px;
        }

        .header p {
            font-size: 12px;
            color: #888888;
            font-weight: 400;
        }

        .calendar-container {
            padding: 24px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .month-nav {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .nav-btn {
            background: #2a2a2a;
            color: #e5e5e5;
            border: 1px solid #404040;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
            font-family: inherit;
            font-weight: 400;
        }

        .nav-btn:hover {
            background: #333333;
            border-color: #555555;
        }

        .current-month {
            font-size: 18px;
            font-weight: 400;
            color: #ffffff;
            letter-spacing: 0px;
        }

        .stats {
            display: flex;
            gap: 16px;
        }

        .stat-card {
            background: #2a2a2a;
            padding: 16px 20px;
            text-align: center;
            border: 1px solid #404040;
            min-width: 100px;
            transition: all 0.2s ease;
        }

        .stat-card:hover {
            background: #333333;
        }

        .stat-number {
            font-size: 18px;
            font-weight: 400;
            color: #ffffff;
            margin-bottom: 4px;
        }

        .stat-label {
            color: #888888;
            font-size: 10px;
            font-weight: 400;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .export-btn {
            background: #000000;
            color: #ffffff;
            border: 1px solid #333333;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s ease;
            font-family: inherit;
            font-weight: 400;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .export-btn:hover {
            background: #1a1a1a;
            border-color: #555555;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            border: 1px solid #333333;
            overflow: hidden;
            background: #1a1a1a;
        }

        .day-header {
            background: #2a2a2a;
            color: #888888;
            padding: 12px 8px;
            text-align: center;
            font-weight: 400;
            font-size: 11px;
            border-right: 1px solid #333333;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .day-header:last-child {
            border-right: none;
        }

        .day-cell {
            background: #1a1a1a;
            min-height: 100px;
            padding: 8px;
            position: relative;
            border-right: 1px solid #333333;
            border-bottom: 1px solid #333333;
            transition: background-color 0.2s ease;
        }

        .day-cell:nth-child(7n) {
            border-right: none;
        }

        .day-cell:hover {
            background: #222222;
        }

        .day-number {
            font-weight: 400;
            color: #e5e5e5;
            margin-bottom: 6px;
            font-size: 13px;
        }

        .appointment {
            background: #333333;
            color: #ffffff;
            padding: 6px 8px;
            font-size: 10px;
            margin: 2px 0;
            cursor: pointer;
            transition: all 0.2s ease;
            line-height: 1.2;
            border: 1px solid #404040;
        }

        .appointment:hover {
            background: #404040;
        }

        .appointment-time {
            font-weight: 400;
            font-size: 9px;
            margin-bottom: 1px;
        }

        .appointment-phone {
            font-size: 8px;
            opacity: 0.8;
            font-weight: 400;
        }

        .other-month {
            background: #0f0f0f;
            color: #555555;
        }

        .today {
            background: #1a1a1a !important;
            border: 2px solid #ffffff;
        }

        .today .day-number {
            color: #ffffff;
            font-weight: 400;
            font-size: 14px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
        }

        .modal-content {
            background: #1a1a1a;
            margin: 5% auto;
            padding: 24px;
            width: 90%;
            max-width: 500px;
            position: relative;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
            border: 1px solid #333333;
        }

        .close {
            position: absolute;
            right: 16px;
            top: 16px;
            font-size: 20px;
            cursor: pointer;
            color: #888888;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .close:hover {
            color: #ffffff;
            background: #333333;
        }

        .appointment-details h3 {
            color: #ffffff;
            margin-bottom: 20px;
            font-size: 16px;
            font-weight: 400;
            letter-spacing: 0px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #333333;
            font-size: 12px;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: 400;
            color: #888888;
            text-transform: uppercase;
            font-size: 9px;
            letter-spacing: 0.5px;
        }

        .detail-value {
            color: #ffffff;
            font-weight: 400;
        }

        .no-appointments {
            text-align: center;
            color: #555555;
            font-style: italic;
            padding: 16px;
            font-size: 11px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #888888;
            font-size: 13px;
        }

        .status-eligible {
            color: #00ff88;
            font-weight: 400;
        }

        .status-ineligible {
            color: #ff4444;
            font-weight: 400;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        ::-webkit-scrollbar-thumb {
            background: #333333;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555555;
        }

        @media (max-width: 768px) {
            .calendar-container {
                padding: 16px;
            }
            
            .calendar-header {
                flex-direction: column;
                gap: 16px;
                align-items: stretch;
            }
            
            .stats {
                justify-content: space-between;
            }
            
            .day-cell {
                min-height: 80px;
            }

            .modal-content {
                margin: 10% auto;
                width: 95%;
                padding: 20px;
            }

            .header {
                padding: 16px 20px;
            }

            .header h1 {
                font-size: 18px;
            }
        }

        @media (max-width: 480px) {
            .stats {
                flex-direction: column;
                gap: 8px;
            }

            .stat-card {
                min-width: auto;
            }

            .calendar-container {
                padding: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>MediScreen Calendar</h1>
            <p>Clinical Trial Appointment Management</p>
        </div>
        
        <div class="calendar-container">
            <div class="calendar-header">
                <div class="month-nav">
                    <button class="nav-btn" onclick="changeMonth(-1)">‹</button>
                    <div class="current-month" id="currentMonth">October 2024</div>
                    <button class="nav-btn" onclick="changeMonth(1)">›</button>
                </div>
                
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalAppointments">0</div>
                        <div class="stat-label">Total</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="thisMonthAppointments">0</div>
                        <div class="stat-label">This Month</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="eligiblePatients">0</div>
                        <div class="stat-label">Eligible</div>
                    </div>
                    <button class="export-btn" onclick="exportAppointments()">Export</button>
                </div>
            </div>
            
            <div class="calendar-grid" id="calendarGrid">
                <div class="loading">Loading appointments...</div>
            </div>
        </div>
    </div>

    <!-- Appointment Details Modal -->
    <div id="appointmentModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">×</span>
            <div class="appointment-details" id="appointmentDetails">
                <!-- Appointment details will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        let currentDate = new Date();
        let appointments = [];

        function loadAppointments() {
            fetch('/api/appointments')
                .then(response => response.json())
                .then(data => {
                    appointments = data.map(apt => ({
                        ...apt,
                        date: parseAvailabilityDate(apt.availability_date)
                    }));
                    
                    updateStats();
                    renderCalendar();
                })
                .catch(error => {
                    console.error('Error loading appointments:', error);
                    document.getElementById('calendarGrid').innerHTML = 
                        '<div class="loading">Error loading appointments. Please try again.</div>';
                });
        }

        function parseAvailabilityDate(dateStr) {
            if (dateStr.includes('/')) {
                const [month, day] = dateStr.split('/');
                return new Date(2024, parseInt(month) - 1, parseInt(day));
            }
            return new Date();
        }

        function updateStats() {
            const total = appointments.length;
            const thisMonth = appointments.filter(apt => 
                apt.date.getMonth() === currentDate.getMonth() && 
                apt.date.getFullYear() === currentDate.getFullYear()
            ).length;
            const eligible = appointments.filter(apt => apt.eligible).length;

            document.getElementById('totalAppointments').textContent = total;
            document.getElementById('thisMonthAppointments').textContent = thisMonth;
            document.getElementById('eligiblePatients').textContent = eligible;
        }

        function renderCalendar() {
            const calendarGrid = document.getElementById('calendarGrid');
            calendarGrid.innerHTML = '';

            // Day headers
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                const header = document.createElement('div');
                header.className = 'day-header';
                header.textContent = day;
                calendarGrid.appendChild(header);
            });

            // Get first day of month and number of days
            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDay = firstDay.getDay();

            // Add empty cells for days before month starts
            for (let i = 0; i < startingDay; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'day-cell other-month';
                calendarGrid.appendChild(emptyCell);
            }

            // Add days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'day-cell';
                
                const cellDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
                const isToday = isSameDay(cellDate, new Date());
                
                if (isToday) {
                    dayCell.classList.add('today');
                }

                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = day;
                dayCell.appendChild(dayNumber);

                // Add appointments for this day
                const dayAppointments = appointments.filter(apt => 
                    isSameDay(apt.date, cellDate)
                );

                dayAppointments.forEach(apt => {
                    const appointmentEl = document.createElement('div');
                    appointmentEl.className = 'appointment';
                    appointmentEl.innerHTML = `
                        <div class="appointment-time">10:00 AM</div>
                        <div class="appointment-phone">${apt.phone}</div>
                    `;
                    appointmentEl.onclick = () => showAppointmentDetails(apt);
                    dayCell.appendChild(appointmentEl);
                });

                if (dayAppointments.length === 0) {
                    const noAppointments = document.createElement('div');
                    noAppointments.className = 'no-appointments';
                    noAppointments.textContent = 'No appointments';
                    dayCell.appendChild(noAppointments);
                }

                calendarGrid.appendChild(dayCell);
            }

            // Update month display
            document.getElementById('currentMonth').textContent = 
                currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        }

        function isSameDay(date1, date2) {
            return date1.getDate() === date2.getDate() &&
                   date1.getMonth() === date2.getMonth() &&
                   date1.getFullYear() === date2.getFullYear();
        }

        function changeMonth(direction) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            renderCalendar();
        }

        function showAppointmentDetails(appointment) {
            const modal = document.getElementById('appointmentModal');
            const details = document.getElementById('appointmentDetails');
            
            details.innerHTML = `
                <h3>Appointment Details</h3>
                <div class="detail-row">
                    <span class="detail-label">Call ID</span>
                    <span class="detail-value">${appointment.id}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Phone</span>
                    <span class="detail-value">${appointment.phone}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Age</span>
                    <span class="detail-value">${appointment.age}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Availability</span>
                    <span class="detail-value">${appointment.availability_date}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Medical Conditions</span>
                    <span class="detail-value">${appointment.medical_conditions && appointment.medical_conditions.length > 0 ? appointment.medical_conditions.join(', ') : 'None'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Medications</span>
                    <span class="detail-value">${appointment.medications && appointment.medications.length > 0 ? appointment.medications.join(', ') : 'None'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Eligible</span>
                    <span class="detail-value ${appointment.eligible ? 'status-eligible' : 'status-ineligible'}">
                        ${appointment.eligible ? 'Yes' : 'No'}
                    </span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Created</span>
                    <span class="detail-value">${appointment.created_at}</span>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        function closeModal() {
            document.getElementById('appointmentModal').style.display = 'none';
        }

        function exportAppointments() {
            fetch('/api/export')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Appointments exported successfully!\n\nFiles created:\n- appointments.csv\n- appointments.json\n- appointments.ics');
                    } else {
                        alert('Export failed: ' + data.message);
                    }
                })
                .catch(error => {
                    alert('Export failed: ' + error.message);
                });
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('appointmentModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }

        // Initialize calendar
        loadAppointments();
    </script>
</body>
</html>